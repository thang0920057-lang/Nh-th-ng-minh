<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gi√°m s√°t c·∫£m bi·∫øn IoT</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h2>üìä Tr·ª±c quan h√≥a d·ªØ li·ªáu c·∫£m bi·∫øn t·ª´ CSV</h2>

    <!-- Bi·ªÉu ƒë·ªì -->
    <canvas id="sensorChart"></canvas>

    <!-- B·∫£ng d·ªØ li·ªáu -->
    <h3>üìã D·ªØ li·ªáu c·∫£m bi·∫øn</h3>
    <table id="dataTable">
        <thead>
            <tr>
                <th>Th·ªùi gian</th>
                <th>Nhi·ªát ƒë·ªô (¬∞C)</th>
                <th>ƒê·ªô ·∫©m (%)</th>
                <th>√Ånh s√°ng</th>
                <th>Kh√≠ gas</th>
                <th>√Çm thanh</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        var ctx = document.getElementById('sensorChart').getContext('2d');
        var chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'Nhi·ªát ƒë·ªô (¬∞C)', data: [], borderColor: 'red', fill: false },
                    { label: 'ƒê·ªô ·∫©m (%)', data: [], borderColor: 'blue', fill: false },
                    { label: '√Ånh s√°ng', data: [], borderColor: 'yellow', fill: false },
                    { label: 'Kh√≠ gas', data: [], borderColor: 'green', fill: false },
                    { label: '√Çm thanh', data: [], borderColor: 'purple', fill: false }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        title: { display: true, text: 'Th·ªùi gian' },
                        ticks: {
                            autoSkip: true,        // T·ª± ƒë·ªông b·ªè b·ªõt nh√£n n·∫øu qu√° nhi·ªÅu
                            maxTicksLimit: 10      // Gi·ªõi h·∫°n s·ªë nh√£n hi·ªÉn th·ªã tr√™n tr·ª•c X
                        }
                    },
                    y: {
                        title: { display: true, text: 'Gi√° tr·ªã c·∫£m bi·∫øn' }
                    }
                },
                elements: {
                    point: { radius: 3 }   // Gi·∫£m k√≠ch th∆∞·ªõc ƒëi·ªÉm d·ªØ li·ªáu ƒë·ªÉ tr√°nh b·ªã ch·ªìng l√™n nhau
                }
            }
        });

        function fetchData() {
            fetch('/data')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error("L·ªói khi t·∫£i d·ªØ li·ªáu:", data.error);
                        return;
                    }

                    var tableBody = document.querySelector("#dataTable tbody");
                    tableBody.innerHTML = "";  // X√≥a d·ªØ li·ªáu c≈©

                    chart.data.labels = [];
                    for (var i = 0; i < chart.data.datasets.length; i++) {
                        chart.data.datasets[i].data = [];
                    }

                    data.forEach(entry => {
                        var time = new Date(entry.Timestamp).toLocaleTimeString(); // Chuy·ªÉn timestamp v·ªÅ d·∫°ng th·ªùi gian ng·∫Øn
                        chart.data.labels.push(time);

                        chart.data.datasets[0].data.push(parseFloat(entry.Temperature));
                        chart.data.datasets[1].data.push(parseFloat(entry.Humidity));
                        chart.data.datasets[2].data.push(parseFloat(entry.Light));
                        chart.data.datasets[3].data.push(parseFloat(entry.Gas));
                        chart.data.datasets[4].data.push(parseFloat(entry.Sound));

                        var row = tableBody.insertRow();
                        row.insertCell(0).innerText = time;
                        row.insertCell(1).innerText = entry.Temperature;
                        row.insertCell(2).innerText = entry.Humidity;
                        row.insertCell(3).innerText = entry.Light;
                        row.insertCell(4).innerText = entry.Gas;
                        row.insertCell(5).innerText = entry.Sound;
                    });

                    chart.update();
                })
                .catch(error => console.error("L·ªói t·∫£i d·ªØ li·ªáu:", error));
        }

        // C·∫≠p nh·∫≠t d·ªØ li·ªáu m·ªói 10 gi√¢y
        fetchData();
        setInterval(fetchData, 10000);
    </script>
</body>
</html>
